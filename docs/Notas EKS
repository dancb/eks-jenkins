Acces Key (mywizard): AKIAUND45NE57MU3BIVU
Secret key (mywizard): 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

####################################################################################
################## AHORA VIENE CONFIG EXCLUSIVA PARA ALB CONTROLLER V2 #############
####################################################################################

1- Configurar OIDC Provider: Asegúrate de que tu clúster tenga un proveedor OIDC habilitado:
    eksctl utils associate-iam-oidc-provider --region us-east-1 --cluster eks-cluster-jenkins --approve

2- Crear la IAM Policy: Descarga la política oficial de permisos y créala en AWS:
    curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json
    aws iam create-policy --policy-name AWSLoadBalancerControllerIAMPolicy --policy-document file://iam_policy.json

3- Crear la IAM Role para el Service Account: Crea el Service Account con la IAM Role asociada:
    eksctl create iamserviceaccount \
    --cluster eks-cluster-jenkins \
    --namespace kube-system \
    --name aws-load-balancer-controller \
    --attach-policy-arn arn:aws:iam::303057168699:policy/AWSLoadBalancerControllerIAMPolicy \
    --approve

4- Instalar el AWS Load Balancer Controller con Helm: Añade el repositorio de Helm y actualiza:
    helm repo add eks https://aws.github.io/eks-charts
    helm repo update

5- Luego, instala el AWS Load Balancer Controller:
    kubectl get deployment -n kube-system aws-load-balancer-controller

6- Instalar el controller con Helm
    6.1- Obten la vpc del cluster: aws eks describe-cluster --name eks-cluster-jenkins --query "cluster.resourcesVpcConfig.vpcId" --output text
    6.2- Asocia la VPC al helm chart y ejecutalo
        helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
        -n kube-system \
        --set clusterName=eks-cluster-jenkins \
        --set serviceAccount.create=false \
        --set serviceAccount.name=aws-load-balancer-controller \
        --set region=us-east-1 \
        --set vpcId=vpc-063fbde164c26ff35

7- Validacion 
    7.1- Verifica los Pods y Deployments: Usa el siguiente comando para comprobar que el deployment del controlador esté activo y que los pods estén corriendo:
        kubectl get deployment -n kube-system aws-load-balancer-controller
        kubectl get pods -n kube-system

    7.2- Revisa los logs del controlador: Puedes revisar los logs del controlador para detectar posibles errores:
        kubectl logs -n kube-system deployment/aws-load-balancer-controller
    
    7.3 Instala nginx y valida que puedas llegar

8- Prueba simple instalando pod con un nginx (use esta guia de referencia: https://medium.com/@shivam77kushwah/integrate-application-load-balancer-with-aws-eks-using-aws-load-balancer-controller-7e9b7d178a79)
    8.1- Aplica el deployment de nginx
        kubectl apply -f nginx-deployment.yaml

    8.2- Aplica el service
        kubectl apply -f nginx-service.yaml

    8.3- Verifica que el servicio tiene external-ip asignada
        kubectl get svc nginx-service

    8.4- Crear ingress
        kubectl apply -f nginx-ingress.yaml
    
    8.5- Eliminar service en caso que sea necesario:
        kubectl delete svc nginx-service
